<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stroke Rate Counter</title>
    <meta name="description" content="Professional stroke rate counter for rowing">
    <meta name="theme-color" content="#1f2937">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./favicon.ico">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useCallback, useEffect } = React;

        // ÂÆöÊï∞
        const CHATTER_THRESHOLD = 500;
        const CLEANUP_THRESHOLD = 10000;
        const INACTIVE_THRESHOLD = 10000;

        // „É°„Ç§„É≥„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
        const StrokeRateCounter = () => {
            const [taps, setTaps] = useState([]);
            const [currentRate, setCurrentRate] = useState(0);
            const [lastTapTime, setLastTapTime] = useState(null);
            const [isActive, setIsActive] = useState(false);
            const [debugInfo, setDebugInfo] = useState('');
            const [ignoredTaps, setIgnoredTaps] = useState(0);
            const [rateHistory, setRateHistory] = useState([]);
            const [showDebug, setShowDebug] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [showStats, setShowStats] = useState(false);
            const [soundEnabled, setSoundEnabled] = useState(true);

            // Âè§„ÅÑ„Çø„ÉÉ„Éó„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            const cleanupTaps = useCallback((currentTime, tapArray) => {
                return tapArray.filter(tapTime => currentTime - tapTime < CLEANUP_THRESHOLD);
            }, []);

            // „É¨„Éº„ÉàË®àÁÆó
            const calculateRate = useCallback((tapArray) => {
                if (tapArray.length < 2) return 0;
                
                const currentTime = Date.now();
                const recentTaps = cleanupTaps(currentTime, tapArray);
                
                if (recentTaps.length < 2) return 0;
                
                const sampleSize = Math.min(6, recentTaps.length);
                const recentSamples = recentTaps.slice(-sampleSize);
                
                let totalInterval = 0;
                const intervals = [];
                for (let i = 1; i < recentSamples.length; i++) {
                    const interval = recentSamples[i] - recentSamples[i - 1];
                    totalInterval += interval;
                    intervals.push(interval);
                }
                
                const averageInterval = totalInterval / (recentSamples.length - 1);
                const ratePerMinute = (60 * 1000) / averageInterval;
                
                const minInterval = Math.min(...intervals);
                const maxInterval = Math.max(...intervals);
                setDebugInfo(`ÈñìÈöî: ${intervals.map(i => `${Math.round(i/1000*10)/10}s`).join(', ')} | Âπ≥Âùá: ${Math.round(averageInterval/1000*10)/10}s (${Math.round(minInterval/1000*10)/10}-${Math.round(maxInterval/1000*10)/10}s)`);
                
                return Math.round(ratePerMinute);
            }, [cleanupTaps]);

            // Èü≥Â£∞ÂÜçÁîü
            const playTapSound = useCallback(async () => {
                if (!soundEnabled) return;
                
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    if (audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }
                    
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (error) {
                    console.log('Audio not supported:', error);
                }
            }, [soundEnabled]);

            // „Çø„ÉÉ„Éó„Éè„É≥„Éâ„É©„Éº
            const handleTap = useCallback(() => {
                const now = Date.now();
                
                if (lastTapTime && now - lastTapTime < CHATTER_THRESHOLD) {
                    setIgnoredTaps(prev => prev + 1);
                    return;
                }
                
                playTapSound();
                
                setTaps(prevTaps => {
                    const newTaps = [...prevTaps, now];
                    const rate = calculateRate(newTaps);
                    setCurrentRate(rate);
                    
                    if (rate > 0) {
                        const timestamp = new Date(now);
                        setRateHistory(prev => {
                            const newHistory = [...prev, { 
                                rate, 
                                time: timestamp.toLocaleTimeString('ja-JP', { 
                                    hour: '2-digit', 
                                    minute: '2-digit', 
                                    second: '2-digit' 
                                }),
                                timestamp: now
                            }];
                            return newHistory.slice(-50);
                        });
                    }
                    
                    return cleanupTaps(now, newTaps);
                });
                
                setLastTapTime(now);
                setIsActive(true);
            }, [lastTapTime, playTapSound, calculateRate, cleanupTaps]);

            // Èùû„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
            useEffect(() => {
                if (!lastTapTime) return;
                
                const timer = setInterval(() => {
                    const now = Date.now();
                    if (now - lastTapTime > INACTIVE_THRESHOLD) {
                        setIsActive(false);
                        setCurrentRate(0);
                    }
                }, 100);
                
                return () => clearInterval(timer);
            }, [lastTapTime]);

            // „É™„Çª„ÉÉ„Éà
            const handleReset = useCallback(() => {
                setTaps([]);
                setCurrentRate(0);
                setLastTapTime(null);
                setIsActive(false);
                setIgnoredTaps(0);
                setRateHistory([]);
            }, []);

            // Áµ±Ë®àË®àÁÆó
            const getStats = useCallback(() => {
                if (rateHistory.length < 2) return null;
                
                const rates = rateHistory.map(entry => entry.rate);
                const avg = Math.round(rates.reduce((sum, rate) => sum + rate, 0) / rates.length);
                const min = Math.min(...rates);
                const max = Math.max(...rates);
                const latest5 = rates.slice(-5);
                const recent = latest5.length > 0 ? Math.round(latest5.reduce((sum, rate) => sum + rate, 0) / latest5.length) : 0;
                
                return { avg, min, max, recent };
            }, [rateHistory]);

            // ËÉåÊôØËâ≤
            const getBackgroundClass = () => {
                if (taps.length === 0) return 'from-gray-700 via-gray-600 to-gray-500';
                return isActive 
                    ? 'from-green-800 via-green-700 to-green-600'
                    : 'from-amber-800 via-amber-700 to-amber-600';
            };

            return (
                <div className={`w-full h-screen flex text-white overflow-hidden select-none transition-all duration-500 bg-gradient-to-br ${getBackgroundClass()}`}>
                    {/* „É°„Ç§„É≥„Ç®„É™„Ç¢ */}
                    <div className="flex-1 flex flex-col items-center justify-center relative">
                        {/* „Éò„ÉÉ„ÉÄ„Éº */}
                        <header className="absolute top-4 left-4 right-16 text-center">
                            <h1 className="text-xl font-bold opacity-80">Stroke Rate Counter</h1>
                        </header>
                        
                        {/* Áµ±Ë®à„Éë„Éç„É´ */}
                        {showStats && (() => {
                            const stats = getStats();
                            return (
                                <div className="absolute top-20 left-4 bg-black bg-opacity-40 backdrop-blur-sm rounded-lg p-3">
                                    <h3 className="text-sm font-semibold mb-2 opacity-80">Áµ±Ë®àÊÉÖÂ†±</h3>
                                    {stats ? (
                                        <div className="space-y-1 text-xs">
                                            <div className="flex justify-between">
                                                <span className="opacity-70">Âπ≥Âùá:</span>
                                                <span className="font-mono">{stats.avg} SPM</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="opacity-70">ÊúÄËøë5Âõû:</span>
                                                <span className="font-mono">{stats.recent} SPM</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="opacity-70">ÊúÄÈ´ò:</span>
                                                <span className="font-mono">{stats.max} SPM</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="opacity-70">ÊúÄ‰Ωé:</span>
                                                <span className="font-mono">{stats.min} SPM</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="opacity-70">Â§âÂãï:</span>
                                                <span className="font-mono">{stats.max - stats.min} SPM</span>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-xs opacity-60">„Éá„Éº„Çø‰∏çË∂≥</div>
                                    )}
                                </div>
                            );
                        })()}
                        
                        {/* „É¨„Éº„ÉàË°®Á§∫ */}
                        <div className="flex-1 flex flex-col items-center justify-center">
                            <div className={`transition-all duration-300 ${isActive ? 'scale-100 opacity-100' : 'scale-95 opacity-70'}`}>
                                <div className="text-center mb-4">
                                    <div className="text-8xl md:text-9xl font-bold mb-2 leading-none">
                                        {currentRate}
                                    </div>
                                    <div className="text-2xl md:text-3xl font-medium opacity-80">
                                        SPM
                                    </div>
                                </div>
                            </div>
                            
                            {/* „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫ */}
                            <div className="text-center mb-8">
                                {taps.length === 0 && (
                                    <p className="text-lg opacity-60">ÁîªÈù¢„Çí„Çø„ÉÉ„Éó„Åó„Å¶„É¨„Éº„Éà„ÇíÊ∏¨ÂÆö</p>
                                )}
                                {taps.length === 1 && (
                                    <p className="text-lg opacity-60">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Çø„ÉÉ„Éó...</p>
                                )}
                                {showDebug && isActive && taps.length > 1 && (
                                    <div className="space-y-2">
                                        <div className="flex items-center justify-center space-x-2">
                                            <p className="text-lg">Ê∏¨ÂÆö‰∏≠ ({taps.length}„Çø„ÉÉ„Éó)</p>
                                        </div>
                                        {debugInfo && (
                                            <p className="text-sm opacity-60 font-mono">{debugInfo}</p>
                                        )}
                                        {ignoredTaps > 0 && (
                                            <p className="text-xs opacity-50">ÁÑ°Ë¶ñ„Åï„Çå„Åü„Çø„ÉÉ„Éó: {ignoredTaps}Âõû</p>
                                        )}
                                    </div>
                                )}
                                {showDebug && !isActive && taps.length > 1 && (
                                    <p className="text-lg opacity-60">„Çø„ÉÉ„Éó„ÇíÂÜçÈñã„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà10Áßí„Åß„É™„Çª„ÉÉ„ÉàÔºâ</p>
                                )}
                            </div>
                        </div>
                        
                        {/* „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥Áæ§ */}
                        <div 
                            className="absolute top-4 right-4 flex flex-col space-y-2 z-10"
                            onClick={(e) => e.stopPropagation()}
                            onTouchStart={(e) => e.stopPropagation()}
                        >
                            {/* Èü≥Â£∞Âàá„ÇäÊõø„Åà */}
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    setSoundEnabled(!soundEnabled);
                                }}
                                onTouchStart={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                }}
                                onTouchEnd={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    setSoundEnabled(!soundEnabled);
                                }}
                                className={`p-2 rounded-lg transition-all duration-200 ${
                                    soundEnabled 
                                        ? 'bg-white bg-opacity-30 text-white' 
                                        : 'bg-white bg-opacity-10 text-white text-opacity-60'
                                }`}
                                title="„Çø„ÉÉ„ÉóÈü≥Âàá„ÇäÊõø„Åà"
                            >
                                {soundEnabled ? 'üîä' : 'üîá'}
                            </button>
                            
                            {/* Áµ±Ë®àÂàá„ÇäÊõø„Åà */}
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    setShowStats(!showStats);
                                }}
                                onTouchStart={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                }}
                                onTouchEnd={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    setShowStats(!showStats);
                                }}
                                className={`p-2 rounded-lg transition-all duration-200 ${
                                    showStats 
                                        ? 'bg-white bg-opacity-30 text-white' 
                                        : 'bg-white bg-opacity-10 text-white text-opacity-60'
                                }`}
                                title="Áµ±Ë®àÊÉÖÂ†±Âàá„ÇäÊõø„Åà"
                            >
                                üìä
                            </button>
                            
                            {/* Â±•Ê≠¥Âàá„ÇäÊõø„Åà */}
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    setShowHistory(!showHistory);
                                }}
                                onTouchStart={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                }}
                                onTouchEnd={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    setShowHistory(!showHistory);
                                }}
                                className={`p-2 rounded-lg transition-all duration-200 ${
                                    showHistory 
                                        ? 'bg-white bg-opacity-30 text-white' 
                                        : 'bg-white bg-opacity-10 text-white text-opacity-60'
                                }`}
                                title="Â±•Ê≠¥Ë°®Á§∫Âàá„ÇäÊõø„Åà"
                            >
                                üìã
                            </button>
                            
                            {/* „Éá„Éê„ÉÉ„Ç∞Âàá„ÇäÊõø„Åà */}
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    setShowDebug(!showDebug);
                                }}
                                onTouchStart={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                }}
                                onTouchEnd={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    setShowDebug(!showDebug);
                                }}
                                className={`p-2 rounded-lg transition-all duration-200 ${
                                    showDebug 
                                        ? 'bg-white bg-opacity-30 text-white' 
                                        : 'bg-white bg-opacity-10 text-white text-opacity-60'
                                }`}
                                title="„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Âàá„ÇäÊõø„Åà"
                            >
                                ‚öôÔ∏è
                            </button>
                        </div>
                        
                        {/* „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥ */}
                        <div 
                            className="absolute bottom-4 right-4 z-10"
                            onClick={(e) => e.stopPropagation()}
                            onTouchStart={(e) => e.stopPropagation()}
                        >
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    handleReset();
                                }}
                                onTouchStart={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                }}
                                onTouchEnd={(e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    handleReset();
                                }}
                                className="bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full p-3 transition-all duration-200"
                                title="„É™„Çª„ÉÉ„Éà"
                            >
                                üîÑ
                            </button>
                        </div>
                        
                        {/* „Çø„ÉÉ„Éó„Ç®„É™„Ç¢ */}
                        <div 
                            className="absolute inset-0 cursor-pointer"
                            onClick={handleTap}
                            onTouchStart={(e) => {
                                e.preventDefault();
                                handleTap();
                            }}
                        />
                        
                        {/* Ë™¨Êòé„ÉÜ„Ç≠„Çπ„Éà */}
                        {showDebug && (
                            <div className="absolute bottom-4 left-4 text-sm opacity-60">
                                <p>Âè≥‰∏ã„ÅÆ„Éú„Çø„É≥„Åß„É™„Çª„ÉÉ„Éà</p>
                                <p>0.5Áßí‰ª•ÂÜÖ„ÅÆÈÄ£Á∂ö„Çø„ÉÉ„Éó„ÅØÁÑ°Ë¶ñ</p>
                            </div>
                        )}
                    </div>
                    
                    {/* Â±•Ê≠¥„Çµ„Ç§„Éâ„Éê„Éº */}
                    {showHistory && (
                        <div className="w-32 bg-black bg-opacity-30 backdrop-blur-sm border-l border-white border-opacity-20 flex flex-col">
                            <div className="p-2 border-b border-white border-opacity-20">
                                <h2 className="text-sm font-semibold">
                                    Â±•Ê≠¥
                                    {rateHistory.length > 0 && (
                                        <span className="text-xs opacity-60 block">({rateHistory.length})</span>
                                    )}
                                </h2>
                            </div>
                            <div className="flex-1 overflow-y-auto p-1">
                                {rateHistory.length === 0 ? (
                                    <div className="text-center text-opacity-60 text-white mt-4">
                                        <p className="text-xs">Â±•Ê≠¥„Å™„Åó</p>
                                    </div>
                                ) : (
                                    <div className="space-y-1">
                                        {[...rateHistory].reverse().map((entry, index) => (
                                            <div 
                                                key={entry.timestamp} 
                                                className={`p-1 rounded bg-white bg-opacity-10 text-center
                                                    ${index === 0 ? 'ring-1 ring-yellow-400 ring-opacity-50' : ''}
                                                `}
                                            >
                                                <div className="text-lg font-bold">{entry.rate}</div>
                                                <div className="text-xs opacity-80">{entry.time.slice(-8, -3)}</div>
                                                {index === 0 && (
                                                    <div className="text-xs text-yellow-400">‚óè</div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÈñãÂßã
        ReactDOM.render(<StrokeRateCounter />, document.getElementById('root'));
    </script>
</body>
</html>